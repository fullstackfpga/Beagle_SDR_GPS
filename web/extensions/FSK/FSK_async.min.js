

/* web/extensions/FSK/FSK_async.min.js (web/extensions/FSK/FSK_async.js = Sun May 12 10:49:38 2024) */
function FSK_async(framing,encoding){var t=this;t.framing=framing;t.start_bit=1;t.data_bits=+framing.substr(0,1);t.stop_variable=0;t.raw=0;if(framing.endsWith('0V')){t.stop_bits=0;t.stop_variable=1;}else
if(framing.endsWith('1V')){t.stop_bits=1;t.stop_variable=1;}else
if(framing.endsWith('1.5')){t.stop_bits=1.5;}else
if(framing.endsWith('2')){t.stop_bits=2;}else{t.stop_bits=1;}
if(framing.includes('E')){t.parity_bits=1;t.parity_even=1;}else
if(framing.includes('O')){t.parity_bits=1;t.parity_odd=1;}else
if(framing.includes('P')){t.parity_bits=1;t.parity_ignore=1;}else{t.parity_bits=0;}
if(framing.includes('EFR')){t.EFR=1;if(framing=='EFR2')t.EFR2=1;if(t.EFR2)
fsk_output_char('EFR2 mode displays only uncommon telegrams\n');t.ERF2_test=0;t.EFR_hdr_found=0;t.EFR_ch=[];t.data_bits=8;t.parity_bits=1;t.parity_ignore=1;t.stop_bits=1;t.stop_variable=1;}else{t.EFR=0;t.EFR2=0;}
if(framing=='CHU'){t.CHU=1;t.CHU_ch=[];t.CHU_cn=[];t.data_bits=8;t.parity_bits=0;t.stop_bits=2;t.raw=1;}
t.nbits=t.start_bit+t.data_bits+t.parity_bits+t.stop_bits;if(t.stop_bits==1.5)t.nbits*=2;t.msb=1<<(t.nbits-1);t.data_msb=1<<(t.data_bits-1);console.log('FSK encoder: FSK_async start_bit='+t.start_bit+' data_bits='+t.data_bits+' parity_bits='+t.parity_bits+' stop_bits='+t.stop_bits+' nbits='+t.nbits+' data_msb=0x'+t.data_msb.toString(16)+' msb=0x'+t.msb.toString(16)+' enc='+encoding);t.ITA2=t.ASCII=0;switch(encoding){case'ITA2':default:t.ITA2=1;t.LETTERS=0x1f;t.FIGURES=0x1b;break;case'ASCII':t.ASCII=1;t.LETTERS=-1;t.FIGURES=-1;break;}
t.last_code=0;t.code_ltrs=[];t.ltrs_code=[];t.code_figs=[];t.figs_code=[];t.shift=false;var NUL='\00';var QUO='\'';var LF='\n';var CR='\r';var BEL='\07';var FGS=LTR='_';t.ltrs=[NUL,'E',LF,'A',' ','S','I','U',CR,'D','R','J','N','F','C','K','T','Z','L','W','H','Y','P','Q','O','B','G',FGS,'M','X','V',LTR];t.figs=[NUL,'3',LF,'-',' ',BEL,'8','7',CR,'$','4',QUO,',','!',':','(','5','"',')','2','#','6','0','1','9','?','&',FGS,'.','/',';',LTR];for(var code=0;code<32;code++){var ltrv=t.ltrs[code];if(ltrv!='_'){t.code_ltrs[code]=ltrv;t.ltrs_code[ltrv]=code;}
var figv=t.figs[code];if(figv!='_'){t.code_figs[code]=figv;t.figs_code[figv]=code;}}}
FSK_async.prototype.reset=function(){this.shift=false;}
FSK_async.prototype.get_nbits=function(){return this.nbits;}
FSK_async.prototype.get_msb=function(){return this.msb;}
FSK_async.prototype.code_to_char=function(code,shift,fixed_start){var t=this;var s;if(t.ITA2){s=shift?t.code_figs[code]:t.code_ltrs[code];if(s==undefined)
s=-code;}else{if(t.EFR){s='';var c;if(t.EFR_hdr_found==0){t.EFR_ch.push(code);if(t.EFR_ch.length>4)t.EFR_ch.shift();c=t.EFR_ch;if(c[0]==0x68&&c[1]==c[2]&&c[3]==0x68)t.EFR_hdr_found=1;}else{t.EFR_ch.push(code);c=t.EFR_ch;var ulen=c[1];var len=ulen+(4+2);if(c.length==len){if(c[len-1]==0x16){var time_telegram=(ulen==0xa&&(c[4]&0xf)==0x7&&c[5]==0&&c[6]==0&&(c[13]&0x7f)!=0x7f);if(time_telegram){if(!t.EFR2){var ss=(c[8]>>2).leadingZeros(2);var mm=(c[9]&0x3f).leadingZeros(2);var hh=(c[10]&0x1f).leadingZeros(2);var dst=c[10]&0x80;var dd=c[11]&0x1f;var dy=c[11]>>5;var mo=c[12]&0x0f;var yy=c[13]&0x7f;s=hh+':'+mm+':'+ss+(dst?' DST ':' ST ')+['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][dy-1]+' '+
dd+' '+['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][mo-1]+' 20'+yy;if(0){s+=' | ';for(var i=4;i<c.length-2;i++){s+=c[i].toHex(-2)+' ';}}
s+='\n';}}else{var common_telegram=(ulen==0x13&&(c[4]&0xf)==0&&c[5]==0x20);if(!t.EFR2||(!common_telegram||t.ERF2_test)){if(t.EFR2){var d=new Date();s=d.toUTCString().substr(5,20)+' ';t.ERF2_test=0;}
if(0){for(var i=0;i<4;i++){s+=c[i].toHex(-2)+' ';}}else{s+='len='+ulen.toHex(-2)+' ';}
s+='C='+c[4].toHex(-2)+' ';s+='A='+c[5].toHex(-2)+' ';s+='CI='+c[6].toHex(-2)+' [';for(var i=7;i<c.length-2;i++){s+=c[i].toHex(-2)+((i==c.length-3)?'] ':' ');}
s+='ck='+c[c.length-2].toHex(-2)+' ';s+='|';for(var i=7;i<c.length-2;i++){s=s+((c[i]>=0x20&&c[i]<0x7f)?String.fromCharCode(c[i]):'.');}
s+='|\n';}}}
t.EFR_ch=[];t.EFR_hdr_found=0;}}}else
if(t.CHU){s='';if(fixed_start){t.CHU_ch=[];t.CHU_cn=[];}
code=(((code&0xf)<<4)&0xf0)|(((code&0xf0)>>>4)&0xf);t.CHU_ch.push(code);t.CHU_cn.push(code^0xff);var dump=function(a){var s=[];a.forEach(function(el,i){s[i]=el.toHex(-2);});return s.join('_');};if(t.CHU_ch.length==10){var c=t.CHU_ch;var f1=c[0]&0xf0,f2=c[5]&0xf0,s1=c[4]&0xf0,s2=c[9]&0xf0;if(f1==0x60&&s1==0x30&&f2==0x60&&s2==0x30&&c[0]==c[5]&&c[1]==c[6]&&c[2]==c[7]&&c[3]==c[8]&&c[4]==c[9]){var d=new Date();s='CHU '+c[2].toHex(-2)+':'+c[3].toHex(-2)+':'+c[4].toHex(-2)+' UTC (browser '+d.toUTCString().substr(17,8)+')\n';}else{var cn=t.CHU_cn;if(c[0]==cn[5]&&c[1]==cn[6]&&c[2]==cn[7]&&c[3]==cn[8]&&c[4]==cn[9]){var yyyy=c[1].toHex(-2)+c[2].toHex(-2);var tai_utc=c[3].toHex(-1);var dst=c[4].toHex(-1);s='CHU year='+yyyy+' DST='+dst+' TAI-UTC='+tai_utc+'\n';}}}}else{if((code>=0x00&&code<=0x09)||(code>=0x0b&&code<=0x0c)||(code>=0x0e&&code<=0x1f)||(code>=0x7f)){s=-1;}else{s=String.fromCharCode(code);}}}
return s;}
FSK_async.prototype.get_code=function(){return this.last_code;}
FSK_async.prototype.check_bits=function(v){var t=this;switch(t.stop_bits){case 1.5:if((v&3)!=0)return false;v>>=2;t.last_code=0;for(var i=0;i<t.data_bits;i++){var d=v&3;if(d!=0&&d!=3)return false;t.last_code=(t.last_code>>1)|(d?t.data_msb:0);v>>=2;}
if((v&7)!=7)return false;v>>=3;if(v!=0)return false;break;default:if(!t.raw&&(v&1)!=0)return false;v>>=1;t.last_code=0;for(var i=0;i<t.data_bits;i++){t.last_code=(t.last_code>>1)|((v&1)?t.data_msb:0);v>>=1;}
if(t.parity_bits==1){v>>=1;}
if(t.stop_bits==2){if(!t.raw&&(v&3)!=3)return false;v>>=2;}else
if(t.stop_bits==1){if(!t.raw&&(v&1)!=1)return false;v>>=1;}
if(!t.raw&&v!=0)return false;break;}
return true;}
FSK_async.prototype.process_char=function(code,fixed_start,cb){var t=this;var success=t.check_bits(code);var tally=0;if(!success){tally=-1;}else{tally=1;if(t.ITA2){switch(t.last_code){case t.LETTERS:t.shift=false;break;case t.FIGURES:t.shift=true;break;default:var chr=t.code_to_char(t.last_code,t.shift);if(chr<0){console.log('FSK_async missed this code: 0x'+Math.abs(chr).toString(16));}else{cb(chr);}
break;}}else{cb(t.code_to_char(t.last_code,false,fixed_start));}}
return{success:success,tally:tally};}



